<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forgot Password | InterviewAI</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      :root {
        --primary: #6366f1;
        --secondary: #8b5cf6;
        --light: #f8fafc;
        --dark: #0f172a;
        --gray: #94a3b8;
        --border: rgba(255, 255, 255, 0.08);
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #0f172a, #1e293b);
        color: #f8fafc;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      /* Toast Notification Styles */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-width: 400px;
      }

      .toast {
        background: rgba(30, 41, 59, 0.95);
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        border-left: 4px solid var(--primary);
        display: flex;
        align-items: center;
        gap: 15px;
        transform: translateX(110%);
        transition: transform 0.3s ease-out;
        backdrop-filter: blur(10px);
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        border-color: var(--success);
      }

      .toast.error {
        border-color: var(--danger);
      }

      .toast-icon {
        font-size: 24px;
        min-width: 24px;
      }

      .toast.success .toast-icon {
        color: var(--success);
      }

      .toast.error .toast-icon {
        color: var(--danger);
      }

      .toast-content {
        flex-grow: 1;
      }

      .toast-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .toast-message {
        font-size: 14px;
        color: #cbd5e1;
      }

      .toast-close {
        background: transparent;
        border: none;
        color: var(--gray);
        cursor: pointer;
        font-size: 18px;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
      }

      .toast-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }


      .container {
        width: 100%;
        max-width: 480px;
        background: rgba(15, 23, 42, 0.8);
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.05);
        overflow: hidden;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 40px;
      }

      .logo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
      }

      .logo i {
        font-size: 36px;
        background: linear-gradient(135deg, #a5b4fc, #c4b5fd);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .logo h1 {
        font-size: 28px;
        font-weight: 700;
        background: linear-gradient(135deg, #e0e7ff, #ede9fe);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      h2 {
        font-size: 24px;
        text-align: center;
        margin-bottom: 15px;
        color: #f8fafc;
      }

      p {
        text-align: center;
        color: #cbd5e1;
        margin-bottom: 30px;
        line-height: 1.6;
      }

      .form-step {
        display: none;
      }

      .form-step.active {
        display: block;
      }

      .form-group {
        margin-bottom: 25px;
      }

      label {
        display: block;
        margin-bottom: 10px;
        font-weight: 500;
        color: #e2e8f0;
      }

      input {
        width: 100%;
        padding: 14px 18px;
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: #f8fafc;
        font-size: 16px;
        transition: all 0.3s;
      }

      input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
      }

      button {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }

      button:hover {
        background: linear-gradient(135deg, #5659e6, #7a4deee1);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
      }

      button:disabled {
        background: rgba(148, 163, 184, 0.4);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .back-link {
        display: block;
        text-align: center;
        margin-top: 25px;
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s;
      }

      .back-link:hover {
        color: #a5b4fc;
      }

      .code-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 25px;
      }

      .code-input {
        width: 55px;
        height: 60px;
        text-align: center;
        font-size: 24px;
        font-weight: 700;
        padding: 0;
      }

      .resend-container {
        text-align: center;
        margin-top: 20px;
      }

      .resend-text {
        color: #94a3b8;
        margin-bottom: 10px;
      }

      .resend-btn {
        background: rgba(30, 41, 59, 0.6);
        color: var(--primary);
        padding: 12px 20px;
        border: 1px solid var(--border);
      }

      .resend-btn:hover {
        background: rgba(67, 97, 238, 0.15);
        transform: translateY(-2px);
      }

      .timer {
        font-weight: 700;
        color: var(--primary);
      }

      .success-message {
        background: rgba(16, 185, 129, 0.15);
        color: var(--success);
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .error-message {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .password-rules {
        font-size: 14px;
        color: #94a3b8;
        margin-top: 8px;
      }

      @media (max-width: 576px) {
        .container {
          padding: 30px 20px;
        }

        .code-input {
          width: 45px;
          height: 50px;
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="container">
      <div class="logo">
        <i class="fas fa-robot"></i>
        <h1>InterviewAI</h1>
      </div>
      <div id="desc">
        <h2>Forgot Password</h2>
        <p>
          Enter your registered email and we'll send you a verification code to
          reset your password.
        </p>
      </div>
      <!-- Step 1: Email Input -->
      <div class="form-step active" id="step1">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder="Enter your email"
            required
          />
        </div>
        <button type="button" id="sendCodeBtn">
          <i class="fas fa-paper-plane"></i>
          Send Verification Code
        </button>
        <a href="{%url 'login'%}" class="back-link">
          <i class="fas fa-arrow-left"></i> Back to Login
        </a>
      </div>

      <!-- Step 2: Code Verification -->
      <div class="form-step" id="step2">
        

        <div class="form-group">
          <label for="code">Enter 6-digit verification code</label>
          <div class="code-container">
            <input
              type="text"
              class="code-input"
              maxlength="1"
              data-index="0"
            />
            <input
              type="text"
              class="code-input"
              maxlength="1"
              data-index="1"
            />
            <input
              type="text"
              class="code-input"
              maxlength="1"
              data-index="2"
            />
            <input
              type="text"
              class="code-input"
              maxlength="1"
              data-index="3"
            />
            <input
              type="text"
              class="code-input"
              maxlength="1"
              data-index="4"
            />
            <input
              type="text"
              class="code-input"
              maxlength="1"
              data-index="5"
            />
          </div>
        </div>

        <button type="button" id="verifyCodeBtn" disabled>
          <i class="fas fa-check"></i>
          Verify Code
        </button>

        <div class="resend-container">
          <p class="resend-text">
            Didn't receive the code? <span class="timer" id="timer">1:00</span>
          </p>
          <button type="button" class="resend-btn" id="resendCodeBtn" disabled>
            <i class="fas fa-redo"></i>
            Resend Code
          </button>
        </div>
      </div>

      <!-- Step 3: New Password -->
      <div class="form-step" id="step3">
        

        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input
            type="password"
            id="newPassword"
            placeholder="Enter your new password"
            required
          />
          <p class="password-rules">
            Must be at least 8 characters with a number and special character
          </p>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <input
            type="password"
            id="confirmPassword"
            placeholder="Confirm your new password"
            required
          />
        </div>

        <button type="button" id="resetPasswordBtn">
          <i class="fas fa-lock"></i>
          Reset Password
        </button>
      </div>

      <!-- Step 4: Success Message -->
      <div class="form-step" id="step4">

        <p>
          Your password has been reset successfully. You can now login with your
          new password.
        </p>

        <button type="button" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i>
          Go to Login
        </button>
      </div>
    </div>

    <script>
      // Toast Notification System
      function showToast(message, type = "info", duration = 5000) {
        const toastContainer = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <div class="toast-icon">
            ${
              type === "success"
                ? '<i class="fas fa-check-circle"></i>'
                : type === "error"
                ? '<i class="fas fa-exclamation-circle"></i>'
                : '<i class="fas fa-info-circle"></i>'
            }
          </div>
          <div class="toast-content">
            <div class="toast-title">${
              type.charAt(0).toUpperCase() + type.slice(1)
            }</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close">
            <i class="fas fa-times"></i>
          </button>
        `;

        toastContainer.appendChild(toast);

        // Show toast with animation
        setTimeout(() => {
          toast.classList.add("show");
        }, 10);

        // Close toast on button click
        const closeBtn = toast.querySelector(".toast-close");
        closeBtn.addEventListener("click", () => {
          toast.classList.remove("show");
          setTimeout(() => {
            toast.remove();
          }, 300);
        });

        // Auto-remove toast after duration
        setTimeout(() => {
          if (toast.classList.contains("show")) {
            toast.classList.remove("show");
            setTimeout(() => {
              toast.remove();
            }, 300);
          }
        }, duration);
      }

      document.addEventListener("DOMContentLoaded", function () {
        // DOM Elements
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");
        const step3 = document.getElementById("step3");
        const step4 = document.getElementById("step4");

        const desc = document.getElementById("desc");
        const emailInput = document.getElementById("email");
        const sendCodeBtn = document.getElementById("sendCodeBtn");
        const codeInputs = document.querySelectorAll(".code-input");
        const verifyCodeBtn = document.getElementById("verifyCodeBtn");
        const timerElement = document.getElementById("timer");
        const resendCodeBtn = document.getElementById("resendCodeBtn");
        const newPasswordInput = document.getElementById("newPassword");
        const confirmPasswordInput = document.getElementById("confirmPassword");
        const resetPasswordBtn = document.getElementById("resetPasswordBtn");
        const loginBtn = document.getElementById("loginBtn");
        let email = "";

        const original_html = resetPasswordBtn.innerHTML;

        // Variables
        let generatedCode = "";
        let timerInterval;
        let timerSeconds = 60; // 1 minute

        // Simulated database of valid emails (in a real app, this would be server-side)
        let validEmails = [""];
        fetch("/get_all_emails/")
          .then((response) => response.json())
          .then((data) => {
            validEmails = data.emails;
          })
          .catch((error) => showToast("Error fetching emails: " + error, "error"));

        // Event Listeners
        sendCodeBtn.addEventListener("click", sendVerificationCode);
        verifyCodeBtn.addEventListener("click", verifyCode);
        resendCodeBtn.addEventListener("click", resendCode);
        resetPasswordBtn.addEventListener("click", resetPassword);
        loginBtn.addEventListener("click", () => {
          window.location.href = '{%url "login"%}';
        });

        // Code input navigation
        codeInputs.forEach((input, index) => {
          input.addEventListener("input", () => {
            // Auto-tab to next input
            if (input.value && index < codeInputs.length - 1) {
              codeInputs[index + 1].focus();
            }

            // Check if all inputs are filled
            checkCodeCompletion();
          });

          input.addEventListener("keydown", (e) => {
            // Handle backspace to move to previous input
            if (e.key === "Backspace" && !input.value && index > 0) {
              codeInputs[index - 1].focus();
            }
          });
        });

        // make send_code_to_email return a Promise
        async function send_code_to_email(email, generatedCode) {
          try {
            const response = await fetch("/send_verification_code/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify({ email: email, code: generatedCode }),
            });

            const data = await response.json();

            if (data.success) {
              showToast("Verification code sent to " + email, "success");
              return true; // success
            } else {
              showToast("Failed to send email: " + data.error, "error");
              return false; // failed
            }
          } catch (error) {
            console.error("Error:", error);
            showToast("Error sending verification code", "error");
            return false;
          }
        }

        async function sendVerificationCode() {
          desc.innerHTML = "";
          email = emailInput.value.trim();

          // Validate email
          if (!isValidEmail(email)) {
            showToast("Please enter a valid email address", "error");
            return;
          }

          // Check if email exists in database (simulated)
          if (!validEmails.includes(email)) {
            showToast("This email is not registered with our system", "error");
            return;
          }

          // Simulate sending code to email
          generatedCode = generateRandomCode();

          // Show next step
          step1.classList.remove("active");
          step2.classList.add("active");

          // wait until email is sent
          const success = await send_code_to_email(email, generatedCode);

          if (success) {
            // Start timer ONLY after success
            startTimer();
          }
        }

        // helper for csrf
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            let cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              let cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }

        function verifyCode() {
          const enteredCode = Array.from(codeInputs)
            .map((input) => input.value)
            .join("");

          if (enteredCode === generatedCode) {
            // Code is correct, proceed to next step
            step2.classList.remove("active");
            step3.classList.add("active");
            clearInterval(timerInterval);
          } else {
            showToast("Invalid verification code. Please try again.", "error");
          }
        }

        async function resendCode() {
          email = emailInput.value.trim();
          
          // Reset and generate new code
          generatedCode = generateRandomCode();

          // Clear input fields
          codeInputs.forEach((input) => (input.value = ""));
          verifyCodeBtn.disabled = true;

          // wait until email is sent
          const success = await send_code_to_email(email, generatedCode);

          // Reset and start timer
          clearInterval(timerInterval);
          timerSeconds = 60;
          startTimer();

          showToast("New verification code sent to your email", "success");
        }

        function resetPassword() {
          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;

          // Validate passwords
          if (!isValidPassword(newPassword)) {
            showToast(
              "Password must be at least 8 characters with a number and special character",
              "error"
            );
            return;
          }

          if (newPassword !== confirmPassword) {
            showToast("Passwords do not match", "error");
            return;
          }

          fetch("/set_new_password/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({
              email: email,
              password: newPassword,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showToast("Password reset successfully!", "success");
                // Show success step
                step3.classList.remove("active");
                step4.classList.add("active");
              } else {
                showToast("Failed to reset password: " + data.error, "error");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              showToast("Error resetting password", "error");
            });
        }

        function startTimer() {
          // Update button state
          resendCodeBtn.disabled = true;

          // Update timer immediately
          updateTimerDisplay();

          // Start countdown
          timerInterval = setInterval(() => {
            timerSeconds--;

            if (timerSeconds <= 0) {
              clearInterval(timerInterval);
              resendCodeBtn.disabled = false;
              verifyCodeBtn.disabled = true;
              timerElement.textContent = "00:00";
            } else {
              updateTimerDisplay();
            }
          }, 1000);
        }

        function updateTimerDisplay() {
          const minutes = Math.floor(timerSeconds / 60);
          const seconds = timerSeconds % 60;
          timerElement.textContent = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }

        function checkCodeCompletion() {
          const allFilled = Array.from(codeInputs).every(
            (input) => input.value
          );
          if (timerSeconds > 0) {
            verifyCodeBtn.disabled = !allFilled;
          }
        }

        function generateRandomCode() {
          return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function isValidEmail(email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return emailRegex.test(email);
        }

        function isValidPassword(password) {
          // At least 8 characters, 1 number, and 1 special character
          const passwordRegex =
            /^(?=.*[0-9])(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{8,}$/;
          return passwordRegex.test(password);
        }
      });
    </script>
  </body>
</html>