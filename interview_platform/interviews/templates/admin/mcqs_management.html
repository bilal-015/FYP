<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCQs Management | InterviewAI</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      :root {
        --primary: #6366f1;
        --primary-light: #818cf8;
        --secondary: #8b5cf6;
        --light: #f8fafc;
        --dark: #0f172a;
        --darker: #0b1220;
        --gray: #94a3b8;
        --border: rgba(255, 255, 255, 0.08);
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --card-bg: rgba(15, 23, 42, 0.8);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, var(--darker), #1e293b);
        min-height: 100vh;
        color: #f8fafc;
        display: flex;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 250px;
        background: var(--dark);
        height: 100vh;
        position: fixed;
        padding: 20px 0;
        border-right: 1px solid var(--border);
        z-index: 100;
      }

      .sidebar-brand {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        margin-bottom: 30px;
      }

      .sidebar-brand i {
        font-size: 28px;
        background: linear-gradient(135deg, #a5b4fc, #c4b5fd);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-right: 10px;
      }

      .sidebar-brand h2 {
        font-size: 22px;
        font-weight: 700;
        background: linear-gradient(135deg, #e0e7ff, #ede9fe);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .sidebar-nav {
        list-style: none;
      }

      .sidebar-nav li {
        margin-bottom: 5px;
      }

      .sidebar-nav a {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #cbd5e1;
        text-decoration: none;
        transition: all 0.3s;
        border-left: 3px solid transparent;
      }

      .sidebar-nav a:hover,
      .sidebar-nav a.active {
        background: rgba(30, 41, 59, 0.6);
        color: #f8fafc;
        border-left: 3px solid var(--primary);
      }

      .sidebar-nav a i {
        margin-right: 12px;
        font-size: 18px;
        width: 24px;
        text-align: center;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 250px;
        padding: 30px;
        width: calc(100% - 250px);
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }

      .user-menu {
        display: flex;
        align-items: center;
      }

      .user-menu img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
        border: 2px solid var(--primary);
      }

      /* Content Sections */
      .content-section {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid var(--border);
        backdrop-filter: blur(10px);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        margin-top: 15px;
      }

      .btn:hover {
        background: linear-gradient(135deg, #5659e6, #7a4deee1);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
      }

      .btn-secondary {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid var(--border);
      }

      .btn-secondary:hover {
        background: rgba(30, 41, 59, 0.8);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn:disabled:hover {
        transform: none;
        box-shadow: none;
      }

      /* Forms */
      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .form-control {
        width: 100%;
        padding: 12px 15px;
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: #f8fafc;
        font-size: 14px;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary);
      }

      textarea.form-control {
        min-height: 120px;
        resize: vertical;
      }

      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-col {
        flex: 1;
      }

      /* MCQ Options */
      .options-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .option-item {
        background: rgba(30, 41, 59, 0.4);
        border-radius: 8px;
        padding: 15px;
        border: 1px solid var(--border);
      }

      .option-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .option-label {
        font-weight: 600;
        color: var(--primary-light);
      }

      /* Tabs */
      .tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
      }

      .tab {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
      }

      .tab.active {
        border-bottom: 2px solid var(--primary);
        color: var(--primary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--card-bg);
        border-left: 4px solid var(--success);
        border-radius: 8px;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s;
        z-index: 1000;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .toast-error {
        border-left-color: var(--danger);
      }

      /* Scraping Section */
      .scraping-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .scraping-results {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 15px;
        background: rgba(30, 41, 59, 0.4);
      }

      .scraped-item {
        padding: 15px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .scraped-item:last-child {
        border-bottom: none;
      }

      .scraped-item-content {
        flex: 1;
      }

      .scraped-item-actions {
        display: flex;
        gap: 10px;
      }

      .code-snippet {
        background: rgba(0, 0, 0, 0.2);
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 13px;
        white-space: pre-wrap;
      }

      /* Responsive */
      @media (max-width: 992px) {
        .sidebar {
          width: 80px;
        }
        .sidebar-brand h2,
        .sidebar-nav span {
          display: none;
        }
        .sidebar-nav a {
          justify-content: center;
          padding: 15px;
        }
        .sidebar-nav a i {
          margin-right: 0;
        }
        .main-content {
          margin-left: 80px;
          width: calc(100% - 80px);
        }
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 20px;
          margin-left: 0;
          width: 100%;
        }
        .sidebar {
          transform: translateX(-100%);
        }
        .form-row {
          flex-direction: column;
          gap: 0;
        }
        .options-container {
          grid-template-columns: 1fr;
        }
        .scraping-controls {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-brand">
        <i class="fas fa-robot"></i>
        <h2>InterviewAI</h2>
      </div>
      <ul class="sidebar-nav">
        <li>
          <a href="{%url 'admin_dashboard'%}"
            ><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a
          >
        </li>
        <li>
          <a href="{%url 'candidates_management'%}"
            ><i class="fas fa-users"></i> <span>Candidates</span></a
          >
        </li>
        <li>
          <a href="{%url 'reports_management'%}"
            ><i class="fas fa-file-alt"></i> <span>Reports</span></a
          >
        </li>
        <li>
          <a href="{%url 'logs_management'%}"
            ><i class="fas fa-clipboard-list"></i> <span>System Logs</span></a
          >
        </li>
        <li>
          <a href="" class="active">
            <i class="fas fa-book"></i> <span>MCQs</span>
          </a>
        </li>
        <li>
          <a href="{%url 'logout'%}"
            ><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a
          >
        </li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1>MCQs Management</h1>
        <div class="user-menu">
          <img src="{{request.session.admin_image}}" alt="" />
          <div>
            <div>{{request.session.admin_full_name}}</div>
            <small>Super Administrator</small>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="manual">Add MCQ Manually</div>
        <div class="tab" data-tab="scraping">Web Scraping</div>
      </div>

      <!-- Manual MCQ Entry -->
      <div class="tab-content active" id="manual-tab">
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">Add New MCQ</h2>
          </div>
          <form id="mcqForm">
            <div class="form-group">
              <label class="form-label" for="question">Question</label>
              <textarea
                class="form-control"
                id="question"
                name="question"
                placeholder="Enter the question text..."
                required
              ></textarea>
            </div>

            <div class="form-group">
              <label class="form-label" for="code_part"
                >Code Part (Optional)</label
              >
              <textarea
                class="form-control"
                id="code_part"
                name="code_part"
                placeholder="Enter any code snippet related to the question..."
              ></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Options</label>
              <div class="options-container">
                <div class="option-item">
                  <div class="option-header">
                    <span class="option-label">Option A</span>
                  </div>
                  <input
                    type="text"
                    class="form-control"
                    name="option_a"
                    placeholder="Enter option A"
                    required
                  />
                </div>
                <div class="option-item">
                  <div class="option-header">
                    <span class="option-label">Option B</span>
                  </div>
                  <input
                    type="text"
                    class="form-control"
                    name="option_b"
                    placeholder="Enter option B"
                    required
                  />
                </div>
                <div class="option-item">
                  <div class="option-header">
                    <span class="option-label">Option C</span>
                  </div>
                  <input
                    type="text"
                    class="form-control"
                    name="option_c"
                    placeholder="Enter option C"
                    required
                  />
                </div>
                <div class="option-item">
                  <div class="option-header">
                    <span class="option-label">Option D</span>
                  </div>
                  <input
                    type="text"
                    class="form-control"
                    name="option_d"
                    placeholder="Enter option D"
                    required
                  />
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-col">
                <label class="form-label" for="correct_answer"
                  >Correct Answer</label
                >
                <select
                  class="form-control"
                  id="correct_answer"
                  name="correct_answer"
                  required
                >
                  <option value="">Select Correct Answer</option>
                  <option value="A">Option A</option>
                  <option value="B">Option B</option>
                  <option value="C">Option C</option>
                  <option value="D">Option D</option>
                </select>
              </div>
              <div class="form-col">
                <label class="form-label" for="domain">Domain</label>
                <select class="form-control" id="domain" name="domain" required>
                  <option value="">Select Domain</option>
                  <option value="Python">Python</option>
                  <option value="Java">Java</option>
                  <option value="C++">C++</option>
                  <option value="OOP">Object Oriented Programming</option>
                  <option value="Data Structures">Data Structures</option>
                  <option value="Networking">Networking</option>
                  <option value="Cyber Security">Cyber Security</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-col">
                <label class="form-label" for="topic">Topic</label>
                <select class="form-control" id="topic" name="topic" required>
                  <option value="">Select Domain First</option>
                  <!-- Topics will be populated based on domain selection -->
                </select>
              </div>
              <div class="form-col">
                <label class="form-label" for="difficulty">Difficulty</label>
                <select
                  class="form-control"
                  id="difficulty"
                  name="difficulty"
                  required
                >
                  <option value="">Select Difficulty</option>
                  <option value="Easy">Easy</option>
                  <option value="Medium">Medium</option>
                  <option value="Hard">Hard</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <button type="submit" class="btn" id="submitBtn">
                <i class="fas fa-plus"></i> Add MCQ
              </button>
              <button type="button" class="btn btn-secondary" id="clearForm">
                <i class="fas fa-eraser"></i> Clear Form
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Web Scraping Tab -->
      <div class="tab-content" id="scraping-tab">
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">Scrape MCQs from Websites</h2>
          </div>

          <div class="form-group">
            <label class="form-label" for="scrapingDomain"
              >Select Domain to Scrape</label
            >
            <select class="form-control" id="scrapingDomain" required>
              <option value="">Select Domain</option>
              <option value="Python">Python</option>
              <option value="Java">Java</option>
              <option value="c++">c++</option>
              <option value="OOP">OOP</option>
              <option value="DataStructures">Data Structures</option>
              <option value="Networking">Networking</option>
              <option value="CyberSecurity">Cyber Security</option>
            </select>
          </div>

          <div class="scraping-controls">
            <button class="btn" id="scrapeBtn" disabled>
              <i class="fas fa-download"></i> Update MCQs from Web Scraping
            </button>
          </div>

          <div class="scraping-results" id="scrapingResults">
            <p class="text-center" style="color: var(--gray)">
              Select a domain and click "Update MCQs from Web Scraping" to begin
            </p>
          </div>

          <div class="form-group" style="text-align: right">
            <button class="btn" id="saveAllBtn" disabled>
              <i class="fas fa-save"></i> Save All to Database
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
      <i class="fas fa-check-circle"></i>
      <span id="toastMessage">Operation completed successfully</span>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // DOM Elements
        const tabs = document.querySelectorAll(".tab");
        const tabContents = document.querySelectorAll(".tab-content");
        const mcqForm = document.getElementById("mcqForm");
        const submitBtn = document.getElementById("submitBtn");
        const clearFormBtn = document.getElementById("clearForm");
        const scrapeBtn = document.getElementById("scrapeBtn");
        const saveAllBtn = document.getElementById("saveAllBtn");
        const scrapingDomain = document.getElementById("scrapingDomain");
        const domainSelect = document.getElementById("domain");
        const topicSelect = document.getElementById("topic");
        const scrapingResults = document.getElementById("scrapingResults");
        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toastMessage");

        // CSRF Token for Django
        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]")
          ? document.querySelector("[name=csrfmiddlewaretoken]").value
          : "";

        // Store scraped MCQs
        let scrapedMCQs = [];

        // Domain to Topics mapping
        const domainTopics = {
          Python: [
            "Basic Syntax",
            "Data Types",
            "Control Structures",
            "Functions",
            "OOP Concepts",
            "Modules and Packages",
            "File Handling",
            "Exception Handling",
            "Decorators",
            "Generators",
            "List Comprehensions",
          ],
          Java: [
            "Basic Syntax",
            "Data Types",
            "Control Structures",
            "OOP Concepts",
            "Inheritance",
            "Polymorphism",
            "Abstraction",
            "Encapsulation",
            "Exception Handling",
            "Collections Framework",
            "Multithreading",
          ],
          "C++": [
            "Basic Concepts",
            "Types",
            "Pointers",
            "Arrays",
            "Structures",
            "Functions",
            "Namespaces",
            "Control Statements",
            "Exceptions",
            "Source Files",
            "Classes",
            "Operators",
            "Derived Classes",
            "Templates",
            "Exception Handling",
            "Class Hierarchies",
            "Standard Library",
            "Containers",
            "Algorithms",
            "Objects",
            "Iterators",
            "Strings",
            "Streams",
            "Numerics",
            "Advanced C++",
          ],

          OOP: [
            "Principles of OOP",
            "Classes and Objects",
            "Inheritance",
            "Polymorphism",
            "Abstraction",
            "Encapsulation",
            "Design Patterns",
          ],
          "Data Structures": [
            "Arrays",
            "Linked Lists",
            "Stacks",
            "Queues",
            "Trees",
            "Graphs",
            "Hash Tables",
            "Sorting Algorithms",
            "Searching Algorithms",
          ],
          Networking: [
            "Network Models",
            "TCP/IP",
            "HTTP",
            "DNS",
            "Socket Programming",
            "Network Security",
            "Routing Protocols",
          ],
          "Cyber Security": [
            "Cryptography",
            "Network Security",
            "Web Security",
            "Ethical Hacking",
            "Penetration Testing",
            "Security Protocols",
            "Vulnerability Assessment",
          ],
        };

        // Demo MCQs data (will be replaced with actual scraped data)
        const demoMCQs = [
          {
            Question: "What is the output of 'print(2 ** 3)' in Python?",
            Code_Part: "print(2 ** 3)",
            Option_A: "6",
            Option_B: "8",
            Option_C: "9",
            Option_D: "5",
            Answer: "B",
            domain: "Python",
            difficulty: "Easy",
          },
          {
            Question:
              "Which method is used to add an element to the end of an array in JavaScript?",
            Code_Part: "",
            Option_A: "push()",
            Option_B: "pop()",
            Option_C: "shift()",
            Option_D: "unshift()",
            Answer: "A",
            domain: "JavaScript",
            difficulty: "Easy",
          },
          {
            Question: "What does the 'final' keyword mean in Java?",
            Code_Part: "public final class MyClass { }",
            Option_A: "The method cannot be overridden",
            Option_B: "The variable is constant",
            Option_C: "The class cannot be extended",
            Option_D: "All of the above",
            Answer: "D",
            domain: "Java",
            difficulty: "Medium",
          },
          {
            Question:
              "Which data structure uses LIFO (Last In First Out) principle?",
            Code_Part: "",
            Option_A: "Queue",
            Option_B: "Stack",
            Option_C: "Array",
            Option_D: "Linked List",
            Answer: "B",
            domain: "Data Structures",
            difficulty: "Easy",
          },
          {
            Question: "What is the time complexity of binary search?",
            Code_Part: "",
            Option_A: "O(1)",
            Option_B: "O(n)",
            Option_C: "O(log n)",
            Option_D: "O(n log n)",
            Answer: "C",
            domain: "Algorithms",
            difficulty: "Medium",
          },
        ];

        // Tab switching functionality
        tabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const tabId = this.getAttribute("data-tab");

            // Update active tab
            tabs.forEach((t) => t.classList.remove("active"));
            this.classList.add("active");

            // Show corresponding content
            tabContents.forEach((content) => {
              content.classList.remove("active");
              if (content.id === `${tabId}-tab`) {
                content.classList.add("active");
              }
            });
          });
        });

        // Enable/disable scrape button based on domain selection
        scrapingDomain.addEventListener("change", function () {
          scrapeBtn.disabled = !this.value;
        });

        // Populate topics based on selected domain
        domainSelect.addEventListener("change", function () {
          const selectedDomain = this.value;
          topicSelect.innerHTML = '<option value="">Select Topic</option>';

          if (selectedDomain && domainTopics[selectedDomain]) {
            domainTopics[selectedDomain].forEach((topic) => {
              const option = document.createElement("option");
              option.value = topic;
              option.textContent = topic;
              topicSelect.appendChild(option);
            });
          }
        });

        // Clear form functionality
        clearFormBtn.addEventListener("click", function () {
          mcqForm.reset();
          topicSelect.innerHTML =
            '<option value="">Select Domain First</option>';
        });

        // Form submission with AJAX to Django backend
        mcqForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          // Check if correct answer is selected
          const correctAnswer = document.getElementById("correct_answer").value;
          if (!correctAnswer) {
            showToast("Please select the correct answer", true);
            return;
          }

          // Check if topic is selected
          const topic = topicSelect.value;
          if (!topic) {
            showToast("Please select a topic", true);
            return;
          }

          // Gather form data
          const formData = new FormData(mcqForm);
          const mcqData = {
            question: formData.get("question"),
            code_part: formData.get("code_part"),
            option_a: formData.get("option_a"),
            option_b: formData.get("option_b"),
            option_c: formData.get("option_c"),
            option_d: formData.get("option_d"),
            answer: correctAnswer,
            domain: formData.get("domain"),
            topic: topic,
            difficulty: formData.get("difficulty"),
          };

          // Disable submit button to prevent multiple submissions
          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Adding MCQ...';

          try {
            // Send data to Django backend
            const response = await fetch("/add_mcq_to_database/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              body: JSON.stringify(mcqData),
            });

            const result = await response.json();

            if (response.ok) {
              if (result.success) {
                showToast("MCQ added successfully!");
                mcqForm.reset();
                topicSelect.innerHTML =
                  '<option value="">Select Domain First</option>';
              } else {
                showToast(result.message || "Error adding MCQ", true);
              }
            } else {
              showToast(result.message || "Server error occurred", true);
            }
          } catch (error) {
            console.error("Error:", error);
            showToast("Network error occurred. Please try again.", true);
          } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add MCQ';
          }
        });

        // Web scraping functionality
        scrapeBtn.addEventListener("click", async function () {
          const selectedDomain = scrapingDomain.value;
          if (!selectedDomain) {
            showToast("Please select a domain first", true);
            return;
          }

          // Disable button during scraping
          scrapeBtn.disabled = true;
          scrapeBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Scraping...';

          showToast(`Scraping ${selectedDomain} MCQs from websites...`);

          try {
            // Call Django backend to scrape MCQs with the selected domain
            const response = await fetch("/scrape_mcqs/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              body: JSON.stringify({ domain: selectedDomain }),
            });

            const result = await response.json();

            if (response.ok) {
              if (result.success) {
                scrapedMCQs = result.mcqs;
                displayScrapedMCQs(scrapedMCQs);
                showToast(
                  `Scraping completed! Found ${result.mcqs.length} MCQs.`
                );
              } else {
                showToast(result.message || "Error scraping MCQs", true);
              }
            } else {
              showToast(result.message || "Server error occurred", true);
            }
          } catch (error) {
            console.error("Error:", error);
            // For demo purposes, show the demo MCQs if the API call fails
            scrapedMCQs = demoMCQs.filter(
              (mcq) => mcq.domain === selectedDomain
            );
            if (scrapedMCQs.length === 0) {
              // If no demo MCQs for the selected domain, show all demo MCQs
              scrapedMCQs = demoMCQs;
            }
            displayScrapedMCQs(scrapedMCQs);
            showToast(
              `Demo mode: Showing ${scrapedMCQs.length} sample MCQs for ${selectedDomain}`
            );
          } finally {
            // Re-enable scrape button
            scrapeBtn.disabled = false;
            scrapeBtn.innerHTML =
              '<i class="fas fa-download"></i> Update MCQs from Web Scraping';
          }
        });

        // Display scraped MCQs in the correct format
        function displayScrapedMCQs(mcqs) {
          scrapingResults.innerHTML = "";

          if (!mcqs || mcqs.length === 0) {
            scrapingResults.innerHTML =
              '<p class="text-center" style="color: var(--gray);">No MCQs found for this domain</p>';
            saveAllBtn.disabled = true;
            return;
          }

          mcqs.forEach((mcq, index) => {
            const mcqElement = document.createElement("div");
            mcqElement.className = "scraped-item";
            mcqElement.innerHTML = `
                              <div class="scraped-item-content">
                                  <strong>${index + 1}. ${mcq.Question}</strong>
                                  ${
                                    mcq.Code_Part
                                      ? `<div class="code-snippet">${mcq.Code_Part}</div>`
                                      : ""
                                  }
                                  <div style="font-size: 14px; margin-top: 10px;">
                                      <div><strong>A:</strong> ${
                                        mcq.Option_A
                                      }</div>
                                      <div><strong>B:</strong> ${
                                        mcq.Option_B
                                      }</div>
                                      <div><strong>C:</strong> ${
                                        mcq.Option_C
                                      }</div>
                                      <div><strong>D:</strong> ${
                                        mcq.Option_D
                                      }</div>
                                      <div style="margin-top: 8px; color: var(--success);"><strong>Correct Answer:</strong> ${
                                        mcq.Answer
                                      }</div>
                                      <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                                          Domain: ${
                                            mcq.domain || scrapingDomain.value
                                          } | Difficulty: ${
              mcq.difficulty || "Not specified"
            }
                                      </div>
                                  </div>
                              </div>
                              <div class="scraped-item-actions">
                                  <button class="btn save-scraped" data-index="${index}"><i class="fas fa-save"></i> Save</button>
                              </div>
                          `;
            scrapingResults.appendChild(mcqElement);
          });

          saveAllBtn.disabled = false;

          // Add event listeners to save buttons
          document.querySelectorAll(".save-scraped").forEach((button) => {
            button.addEventListener("click", async function () {
              const mcqIndex = this.getAttribute("data-index");
              const mcq = scrapedMCQs[mcqIndex];

              // Disable button during save
              this.disabled = true;
              this.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Saving...';

              try {
                // Send MCQ to Django backend
                const response = await fetch("/add_mcq_to_database/", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                  },
                  body: JSON.stringify({
                    question: mcq.Question,
                    code_part: mcq.Code_Part || "",
                    option_a: mcq.Option_A,
                    option_b: mcq.Option_B,
                    option_c: mcq.Option_C,
                    option_d: mcq.Option_D,
                    answer: mcq.Answer,
                    domain: mcq.domain || scrapingDomain.value,
                    difficulty: mcq.difficulty || "Medium",
                  }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                  showToast("MCQ saved successfully!");
                  // Remove from scraped list
                  this.closest(".scraped-item").remove();

                  if (scrapingResults.children.length === 0) {
                    scrapingResults.innerHTML =
                      '<p class="text-center" style="color: var(--gray);">All MCQs have been saved</p>';
                    saveAllBtn.disabled = true;
                  }
                } else {
                  showToast(result.message || "Error saving MCQ", true);
                  // Re-enable button on error
                  this.disabled = false;
                  this.innerHTML = '<i class="fas fa-save"></i> Save';
                }
              } catch (error) {
                console.error("Error:", error);
                showToast("Network error occurred. Please try again.", true);
                // Re-enable button on error
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-save"></i> Save';
              }
            });
          });
        }

        // Save all scraped MCQs
        saveAllBtn.addEventListener("click", async function () {
          const scrapedItems = document.querySelectorAll(".scraped-item");
          if (scrapedItems.length === 0) return;

          // Disable button during save
          saveAllBtn.disabled = true;
          saveAllBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Saving...';

          let savedCount = 0;
          let errorCount = 0;

          // Save each MCQ individually
          for (let i = 0; i < scrapedMCQs.length; i++) {
            const mcq = scrapedMCQs[i];

            try {
              // Send MCQ to Django backend
              const response = await fetch("/add_mcq_to_database/", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({
                  question: mcq.Question,
                  code_part: mcq.Code_Part || "",
                  option_a: mcq.Option_A,
                  option_b: mcq.Option_B,
                  option_c: mcq.Option_C,
                  option_d: mcq.Option_D,
                  answer: mcq.Answer,
                  domain: mcq.domain || scrapingDomain.value,
                  difficulty: mcq.difficulty || "Medium",
                }),
              });

              const result = await response.json();

              if (response.ok && result.success) {
                savedCount++;
              } else {
                errorCount++;
              }
            } catch (error) {
              console.error("Error:", error);
              errorCount++;
            }
          }

          // Show result message
          if (errorCount === 0) {
            showToast(`All ${savedCount} MCQs saved successfully!`);
          } else {
            showToast(
              `Saved ${savedCount} MCQs. ${errorCount} errors occurred.`,
              errorCount > 0
            );
          }

          // Clear the scraped results
          scrapingResults.innerHTML =
            '<p class="text-center" style="color: var(--gray);">All MCQs have been saved</p>';

          // Reset button
          saveAllBtn.disabled = true;
          saveAllBtn.innerHTML =
            '<i class="fas fa-save"></i> Save All to Database';

          // Clear the scraped data
          scrapedMCQs = [];
        });

        // Show toast notification
        function showToast(message, isError = false) {
          toastMessage.textContent = message;
          toast.className = "toast";
          if (isError) {
            toast.classList.add("toast-error");
          }
          toast.classList.add("show");

          setTimeout(() => {
            toast.classList.remove("show");
          }, 3000);
        }
      });
    </script>
  </body>
</html>

